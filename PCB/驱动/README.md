powered by 35's Embedded Systems Inc. A Next generation FlashLight Driver Solution                                                                                                                        

### 概述

Xtern Ripper Lite-HyperBoost是用于DFEx-FarBeaMon3tr的超大功率且高能效的升压恒流驱动器。该驱动器基于全新的FlashLightOS Entry e-Switch固件。在保证了基本手电所需的客制化功能的前提下，删减了一些高阶特性并使用更便宜的中微8051平台。
该驱动器基于私有的X47安装方式，虽然该驱动器并不建议配合东东海47mm D8B外壳使用，但是通过对驱动仓进行车削仍然可以正常安装。该驱动器基于全新的HyperBoost双相交错升压恒流平台，通过使用两个以180度相位角交错运行的boost转换器实现在极大输出功率下仍能高能效运行。

### 性能数据

+ 支持的电池输入类型：3S三元锂电池组，持续放电能力应大于100安培。
+ 支持的LED灯珠类型：3V灯珠6串、6V灯珠3串、9V灯珠2串（支持垂直核心灯珠高Vf运行，设计时应保证极亮时灯珠Vf不超过22.0V）
+ 支持的LED电流：30mA至32或36.00A
+ 温度保护：55度PI环自适应外壳恒温（温控启动后驱动根据外壳散热能力和环境自动调整亮度达到最高可实现的亮度）+65度极亮cutoff+80度强制关机
+ 电池保护：具有欠压自动降档和关机保护以及过电压保护
+ 电池过载保护：具备输入自动限流保护

### 总体操作逻辑

该驱动具备无极调光和传统挡位模式两种逻辑供用户自由选择：
![无极调光](/img/Ramp.png)
![挡位模式](/img/Step.png)

需要补充的是，图中的任意挡位均可以通过单击立即回到关闭状态。对于图中的部分未详尽解释的特殊逻辑，则可参考如下内容：

+ 超级省电应急档：关机状态下双击+长按进入。进入该挡位后侧按的电量指示灯由原来的常亮改为每10秒短暂点亮一次以节约电力消耗（如果电池电量极低，则为红灯慢速闪烁）。该挡位的流明值取决于灯珠性能和V/I特性，通常在*2-3LM*之间。**需要注意的是，该挡位仅用于应急，故没有任何电池电量保护机制。只要电池还有电力就会无限运行直到电池输入低于5V并导致驱动硬件断电。若搭配第三方出品，没有过放保护的电池包将会导致电池因为过放而永久性损坏！**
+ 切换无极调光和挡位模式：关机状态下四击开关，此时开关指示灯将会闪烁三次。如果闪烁颜色为红色则无极调光已被关闭，绿色则为开启。
+ 切换待机状态下的按键指示灯配置：关机状态下七击开关，此时手电侧按将会点亮并用颜色指示长时间放置后侧按指示灯的待机提示的颜色。对于侧按指示灯此时点亮的颜色和待机指示灯模式的配置关系请参考下表：
    + 每0.5秒红色快闪一次：按键待机指示关闭。
    + 绿色：侧按待机指示配置为绿色
    + 红色：侧按待机指示配置为红色
    + 黄色：侧按待机指示配置为黄绿色

当选择好需要的颜色后，长按开关3秒，此时侧按指示灯熄灭且手电主灯闪烁一次，表示配置已保存，手电返回到正常操作模式。需要注意的是，**进入配置模式后系统具有30秒的超时时间**。如果在超时时间内用户没有操作，则系统将会自动退出配置模式并令按键指示灯以红色快闪五次的方式提示配置未保存。 

+ 战术模式：关机状态下六击开关，手电主灯迅速频闪一次表示进入战术模式。默认情况下战术功能为按下开关手电以极亮运行，松开则熄灭。当手电进入战术模式后，侧部按键将会每2秒快闪一次指示当前处于战术模式，此时手电将会保持唤醒，直到无操作10分钟后自动进入休眠并退出战术模式。与此同时，您可以通过双击侧按切换战术模式的功能，切换后的指示如下：
    + 一键极亮模式（默认）：此时手电按下开关极亮，松开灭，侧按指示灯每2秒闪1次，切换到该模式时手电的侧按会用红色快闪3次做提示。
    + 一键爆闪模式：此时手电按下开关进入爆闪，松开灭，侧按指示灯每2秒闪2次，切换到该模式时手电的侧按会用绿色快闪3次做提示。
如果您需要主动退出战术模式，则您可再度六击开关，手电主灯频闪一次指示退出战术模式。
+ 按键锁：关机状态下五击开关，手电主灯点亮0.5秒表示进入锁定模式，此时除五击解锁外的任何操作均被忽略。
+ 查询电量：进入操作和逻辑中的一致（如果手电处于开机状态，则通过双击+长按进入）。当进入电量查询模式后手电首先以红黄绿依次点亮的方式提示用户即将显示电量。如果电池电压在合法范围内，则在延迟1秒后手电将通过红色，黄色和绿色的指定次数闪烁提示用户当前的电池电压。如果电池电压超出显示范围（例如2串模式的驱动意外接入3串的锂电池组）则驱动会通过三次红色闪烁提示电压非法。对于电压显示的计算方式请参考如下内容：

+  99.9V显示模式：红色闪烁次数x10+黄色闪烁次数+绿色闪烁次数x0.1=当前电池电压(V)，例如`红色慢闪1次-黄色快闪一次-绿色慢闪4次`表示电池电压为10x1+0+4x0.1=10.4V。

**注：以上内容中的慢闪指的是持续0.5秒的点亮和持续0.5秒的熄灭交替循环的过程。快闪则是瞬间点亮20mS后熄灭（人眼视觉效果为非常迅速的跳一下）**

播报完电池当前电压后，手电将会在延迟2秒后通过后续的长亮(或者慢闪)提示用户当前电池电压对应的总体电量水平（指示方式参考下文中驱动位于运行状态时的指示）

对于电压指示，驱动在工作状态会通过指示灯点亮的方式提示用户当前系统的电池电量。与此同时，在手电首次装入电池时，驱动还会通过多次黄色快速闪烁指示用户通过配置电阻设置的电池串数（如果闪烁2次则驱动为2串模式，闪烁3次则为三串模式）并且在电池数量指示结束后用一次持续2秒的点亮提示电池电量（指示方式和工作状态时相同）。对于手电当前的电量状态和对应的指示灯状态请参考如下内容：

+ 绿色常亮：电池电量充足
+ 黄色常亮：电池电量较为充足
+ 红色常亮：电池电量不足，请尽快为手电充电
+ 红色慢闪：电池电量严重不足，请立即为手电充电（此时手电的可用挡位和功能将会被限制）

### 错误指示系统

该驱动继承了Xtern Ripper PRO版本的特性，依然具备先进的状态监测系统。在驱动每次通电自检和正常运行过程中，固件会通过ADC采集驱动的运行状态并判断负载和驱动是否运行正常。并且在检测到异常时立即切断驱动输出以避免驱动和被驱动的灯珠损坏。

#### 运行时错误监测和错误ID汇报

在运行期间如果驱动检测到无法解决的致命问题则会进入保护模式避免驱动和灯珠损毁，并通过颈部侧按键的指示灯提示用户发生的错误类型。每个指示循环首先以红黄绿的颜色切换闪烁开始，然后通过紧跟着的红色慢闪次数指示错误ID号，慢闪结束后会停顿一会并重新开始循环，对于ID号所对应的错误描述请参考如下内容：

+ 闪烁1次(Fault_DCDCFailedToStart) 驱动在上电自检尝试启动DCDC时失败。检查驱动输出正极是否对外壳短路，DCDC芯片的使能信号和内部LDO输出电压是否正常。
+ 闪烁2次(Fault_DCDCShort) 驱动在运行时检测到输出短路。
+ 闪烁3次(Fault_InputOVP) 驱动检测到输入电压过高，请检测驱动的电池配置是否和使用的电池配套。
+ 闪烁4次(Fault_DCDCOpen) 驱动在运行时检测到输出空载，请检查LED是否损坏。
+ 闪烁5次(Fault_NTCFailed) 驱动在运行期间检测到测量驱动温度的热敏电阻出现异常，检查热敏电阻和测温部分的上拉电阻是否损坏。
+ 闪烁6次(Fault_OverHeat) 驱动检测到外壳温度过高，请等待手电冷却。冷却后故障会自动解除
+ 闪烁7次(Fault_DCDCPreChargeFailed) 驱动检测到实现CV环可控斜率预充的电路出现故障，请参照[故障排除文档](/FAQ.docx)进行硬件上的检查。

### 固件编译注意事项

#### MCU的CONFIG配置

由于中微单片机内部有一组硬编码于Flash指定区域，用于设置单片机的硬件首选项（例如看门狗，调试模式，低电压保护点等）的配置Word。为了确保编译出来的固件可以在硬件内正常运行，您需要在工程配置(Options for Target 'XRLite'->Debug选项卡->右上角的Settings按钮)的Config设置菜单，按照下表正确填写MCU的配置。错误的CONFIG设置会引起固件工作异常！

+ Power                      :  Inter 5V            
+ WDT                        :  SOFTWARECONTROL     
+ PROTECT                    :  ENABLE              
+ FLASH_DATA_PROTECT         :  ENABLE              
+ LVR                        :  3.5V                
+ DEBUG                      :  Disable             
+ OSC                        :  HSI                 
+ OSC_PRESCALE               :  Fosc/1              
+ HSI_FS                     :  Fhsi/1              
+ EXT_RESET                  :  DISABLE             
+ EXT_RESETSEL               :  P00                 
+ WAKEUP_WAITTIME            :  500us               
+ CPU_WAITCLOCK              :  2T                  
+ WRITE_PROTECT[0-2K]        :  DISABLE             
+ WRITE_PROTECT[2-4K]        :  DISABLE             
+ WRITE_PROTECT[4-6K]        :  DISABLE             
+ WRITE_PROTECT[6-8K]        :  DISABLE             
+ WRITE_PROTECT[8-10K]       :  DISABLE             
+ WRITE_PROTECT[10-12K]      :  DISABLE             
+ WRITE_PROTECT[12-14K]      :  DISABLE             
+ WRITE_PROTECT[14-16K]      :  DISABLE             
+ BOOT                       :  BOOT_DIS            

#### 代码内非语法错误的提示

为了确保用户不会错误的填写部分关键数值（例如温控系统的配置参数）导致固件行为异常，本固件源码内包含一些条件编译的监测代码用于监测非法数值。如果编译时遇到了非语法错误的输出，可以在这里查询相应的错误并进行修正。

+ `Error 001:Invalid Integral Configuration,Trim Value or time-factor out of range!`: 积分器的时间常数和电流修调值决定了积分器的上限，由于积分器所使用的变量为int 16，其值域为-32767到32767。如果积分器上限超过了值域则会导致数值溢出引起程序异常。此时您需要减小电流修调值和时间常数确保两者之积不大于32000。
+ `Error 002:Invalid Integral Configuration,Trim Value or time-factor must not be zero or less than zero!`: 积分器的时间常数和电流修调值决定了积分器的上限，为了确保积分器能正常运行，积分器的上限值不能为0或者负数，请检查填入的数值是否包含负数和0。
+ `Error 003:Emergency Shutdown Temp must not exceeded 85 Celsius!` : 紧急关机温度太高了，不能超过85度
+ `Error 004:Force Disble Turbo Temp must less than Emergency Shutdown Temp for at least 15 Celsius!` :
+ `Error 005:Force Disble Turbo Temp must higher than Constant Temp of Turbo Mode for at least 8 Celsius!`: 强制禁用极亮挡位的温控值应该比紧急关机温度低15度以上，且至少高于极亮恒温温度8度
+ `Error 006:Constant Temperature of Turbo Mode must lagger than Constant Temperature of other mode!`:
+ `Error 007:Constant Temperature of other mode must lagger than Thermal Control Release Temp for 5 Celsius!`: 非极亮挡位的温控恒温温度必须要比极亮挡位的温控数值小，且至少比温控停止的阈值高5度确保温控的稳定运行。
+ `Error 008:Thermal Control Release Temp is too low and will not release at summer!`: PI环的温控释放点太低，在夏天因为手电自发热可能导致温控始终激活，即使通过外力给手电降温也无法正确退出。


----------------------------------------------------------------------------------------------------------------------------------
© redstoner_35 @ 35's Embedded Systems Inc.  2025
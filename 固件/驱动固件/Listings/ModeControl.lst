C51 COMPILER V9.60.0.0   MODECONTROL                                                       05/18/2025 17:01:21 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MODECONTROL
OBJECT MODULE PLACED IN .\Objects\ModeControl.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Logic\ModeControl.c OMF2 OPTIMIZE(9,SPEED) BROWSE MODDP2 INCDIR(.\StdDri
                    -ver\inc;.\Hardware;.\include\Hardware;.\include\Logic;.\include\Middleware;.\include\System) DEFINE(EnableStdGPIO) DEBUG
                    - PRINT(.\Listings\ModeControl.lst) TABS(2) OBJECT(.\Objects\ModeControl.obj)

line level    source

   1          #include "SpecialMode.h"
   2          #include "LEDMgmt.h"
   3          #include "SideKey.h"
   4          #include "LocateLED.h"
   5          #include "BattDisplay.h"
   6          #include "OutputChannel.h"
   7          #include "SysConfig.h"
   8          #include "ADCCfg.h"
   9          #include "TempControl.h"
  10          #include "LowVoltProt.h"
  11          #include "SelfTest.h"
  12          #include "SOS.h"
  13          #include "Beacon.h"
  14          #include "Strobe.h"
  15          
  16          //¼«ÁÁºÍ±¬ÉÁµçÁ÷Ñ¡Ôñ
  17          //#define TurboCurrent32A  //×¢ÊÍµô¿ªÆô36A¼«ÁÁ£¬·ñÔò¼«ÁÁµçÁ÷Îª31.75A£¨ÊÊÅäFV7212D£©
  18          #define FullPowerStrobe //±£ÁôÔò¿ªÆôÈ«¹¦ÂÊ±¬ÉÁ
  19          #define FullPowerBeacon //È«¹¦ÂÊÐÅ±ê
  20          
  21          //µ²Î»½á¹¹Ìå
  22          code ModeStrDef ModeSettings[ModeTotalDepth]=
  23            {
  24              //¹Ø»ú×´Ì¬
  25              {
  26              Mode_OFF,
  27              0,
  28              0,  //µçÁ÷0mA
  29              0,  //¹Ø»ú×´Ì¬ãÐÖµÎª0Ç¿ÖÆ½â³ý¾¯±¨
  30              true,
  31              false,
  32              }, 
  33              //³ö´íÁË
  34              {
  35              Mode_Fault,
  36              0,
  37              0,  //µçÁ÷0mA
  38              0,
  39              false,
  40              false,
  41              }, 
  42              //ÔÂ¹â
  43              {
  44              Mode_Moon,
  45              CalcIREFValue(20),  //Êµ¼ÊÊÇ20
  46              0,   //×îÐ¡µçÁ÷Ã»ÓÃµ½£¬ÎÞÊÓ
  47              2500,  //2.5V¹Ø¶Ï
  48              false, //ÔÂ¹âµµÓÐ×¨ÓÃÈë¿Ú£¬ÎÞÐè´ø¼ÇÒä
  49              false,
  50              },  
  51              //¼«µÍÁÁ
  52              {
  53              Mode_ExtremelyLow,
C51 COMPILER V9.60.0.0   MODECONTROL                                                       05/18/2025 17:01:21 PAGE 2   

  54              CalcIREFValue(200),  //200mA
  55              0,   //×îÐ¡µçÁ÷Ã»ÓÃµ½£¬ÎÞÊÓ
  56              2600,  //2.6V¹Ø¶Ï
  57              true, //´ø¼ÇÒä
  58              false,
  59              },  
  60              //µÍÁÁ
  61              {
  62              Mode_Low,
  63              CalcIREFValue(1000),  //1000mAµçÁ÷
  64              0,   //×îÐ¡µçÁ÷Ã»ÓÃµ½£¬ÎÞÊÓ
  65              2800,  //2.8V¹Ø¶Ï
  66              true,
  67              false,
  68              },
  69              //ÖÐÁÁ
  70              {
  71              Mode_Mid,
  72              CalcIREFValue(2000),  //2000mAµçÁ÷
  73              0,   //×îÐ¡µçÁ÷Ã»ÓÃµ½£¬ÎÞÊÓ
  74              2900,  //2.9V¹Ø¶Ï
  75              true,
  76              false,
  77              },  
  78              //ÖÐ¸ßÁÁ
  79              {
  80              Mode_MHigh,
  81              CalcIREFValue(4000),  //4000mAµçÁ÷
  82              0,   //×îÐ¡µçÁ÷Ã»ÓÃµ½£¬ÎÞÊÓ
  83              3000,  //3V¹Ø¶Ï
  84              true,
  85              true,
  86              },  
  87              //¸ßÁÁ
  88              {
  89              Mode_High,
  90              CalcIREFValue(8000),  //8000mAµçÁ÷
  91              0,   //×îÐ¡µçÁ÷Ã»ÓÃµ½£¬ÎÞÊÓ
  92              3100,  //3.1V¹Ø¶Ï
  93              true,
  94              true,
  95              },  
  96              //¼«ÁÁ
  97              {
  98              Mode_Turbo,
  99              #ifdef TurboCurrent32A
                  CalcIREFValue(31750),  //31.75AµçÁ÷
                  #else
 102              CalcIREFValue(36000),  //36AµçÁ÷(Õë¶Ô7175)
 103              #endif    
 104              0,   //×îÐ¡µçÁ÷Ã»ÓÃµ½£¬ÎÞÊÓ
 105              3400,  //3.4V¹Ø¶Ï
 106              false, //¼«ÁÁ²»ÄÜ´ø¼ÇÒä
 107              true,
 108              },  
 109              //±¬ÉÁ    
 110              {
 111              Mode_Strobe,
 112              #ifndef FullPowerStrobe   
                  CalcIREFValue(22000),  //22AµçÁ÷
                  #else
 115                //È«¹¦ÂÊ±¬ÉÁ¼¤»î
C51 COMPILER V9.60.0.0   MODECONTROL                                                       05/18/2025 17:01:21 PAGE 3   

 116                #ifdef TurboCurrent31A
                    CalcIREFValue(31750),  //31.75AµçÁ÷
                    #else
 119                CalcIREFValue(36000),  //36AµçÁ÷(Õë¶Ô7175)
 120                #endif    
 121              #endif      
 122              0,   //×îÐ¡µçÁ÷Ã»ÓÃµ½£¬ÎÞÊÓ
 123              2500,  //2.5V¹Ø¶Ï(Êµ¼ÊÉÏ2.7¾Í»áÀ­Õ¢£¬ÕâÀïµ÷³É2.5ÊÇÎªÁË±ÜÃâµÍµçÑ¹´¦Àí·´¸´´¥·¢µ¼ÖÂ±¬ÉÁ¹¤×÷Òì³£)
 124              false, //±¬ÉÁ²»ÄÜ´ø¼ÇÒä
 125              true,
 126              }, 
 127              //ÎÞ¼«µ÷¹â    
 128              {
 129              Mode_Ramp,
 130              CalcIREFValue(10000),  //×î´ó 10000mAµçÁ÷
 131              CalcIREFValue(100),   //×îÐ¡ 100mAµçÁ÷
 132              3200,  //3.2V¹Ø¶Ï
 133              false, //²»ÄÜ´ø¼ÇÒä  
 134              true,
 135              }, 
 136              //ÐÅ±êÄ£Ê½
 137              {
 138              Mode_Beacon,
 139              #ifdef FullPowerBeacon
 140                //È«¹¦ÂÊÐÅ±êÄ£Ê½¼¤»î
 141                #ifdef TurboCurrent31A
                    CalcIREFValue(31750),  //31.75AµçÁ÷
                    #else
 144                CalcIREFValue(36000),  //36AµçÁ÷(Õë¶Ô7175)
 145                #endif  
 146              #else 
                    CalcIREFValue(22000),  //22AµçÁ÷
                  #endif
 149              0,   //×îÐ¡µçÁ÷Ã»ÓÃµ½£¬ÎÞÊÓ
 150              2500,  //2.5V¹Ø¶Ï(Êµ¼ÊÉÏ2.7¾Í»áÀ­Õ¢£¬Êµ¼ÊÉÏÕâÀïµ÷³É2.5ÊÇÎªÁË±ÜÃâµÍµçÑ¹´¦Àí·´¸´´¥·¢ÖØÖÃSOS×´Ì¬»úµ¼ÖÂSOS¹¤
             -×÷Òì³£)
 151              false,  //SOS²»ÄÜ´ø¼ÇÒä
 152              true,
 153              }, 
 154              //SOS
 155              {
 156              Mode_SOS,
 157              CalcIREFValue(14000),  //14AµçÁ÷
 158              0,   //×îÐ¡µçÁ÷Ã»ÓÃµ½£¬ÎÞÊÓ
 159              2500,  //2.5V¹Ø¶Ï(Êµ¼ÊÉÏ2.7¾Í»áÀ­Õ¢£¬Êµ¼ÊÉÏÕâÀïµ÷³É2.5ÊÇÎªÁË±ÜÃâµÍµçÑ¹´¦Àí·´¸´´¥·¢ÖØÖÃSOS×´Ì¬»úµ¼ÖÂSOS¹¤
             -×÷Òì³£)
 160              false,  //SOS²»ÄÜ´ø¼ÇÒä
 161              true,
 162              }, 
 163            };
 164          
 165          //È«¾Ö±äÁ¿(µ²Î»)
 166          ModeStrDef *CurrentMode; //µ²Î»½á¹¹ÌåÖ¸Õë
 167          xdata ModeIdxDef LastMode; //µ²Î»¼ÇÒä´æ´¢
 168          SysConfigDef SysCfg; //ÏµÍ³ÅäÖÃ 
 169          
 170          //È«¾Ö±äÁ¿(×´Ì¬Î»)
 171          bit IsRampEnabled; //ÊÇ·ñ¿ªÆôÎÞ¼«µ÷¹â
 172          static bit IsNotifyMaxRampLimitReached=0; //±ê¼ÇÎÞ¼«µ÷¹â´ïµ½×î´óµçÁ÷  
 173            
 174          //Èí¼þ¼ÆÊ±±äÁ¿
 175          xdata char HoldChangeGearTIM; //µ²Î»Ä£Ê½ÏÂ³¤°´»»µ²
C51 COMPILER V9.60.0.0   MODECONTROL                                                       05/18/2025 17:01:21 PAGE 4   

 176          xdata char DisplayLockedTIM; //Ëø¶¨ºÍÕ½ÊõÄ£Ê½½øÈëÍË³öÏÔÊ¾ 
 177          static xdata char RampDIVCNT; //·ÖÆµ¼ÆÊ±Æ÷  
 178            
 179          //»ñÈ¡¼«ÁÁµçÁ÷
 180          static int QueryTurboCurrent(void)  
 181            {
 182   1        //¼«ÁÁMPPTÏÞÁ÷Æô¶¯£¬´Ó¶¯Ì¬¼«ÁÁÏÞÁ÷º¯ÊýÈ¡µçÁ÷ÏÞÖÆ
 183   1        if(TurboILIM<QueryCurrentGearILED())return TurboILIM;
 184   1        //ÆäÓàÇé¿ö£¬´Óµ±Ç°µ²Î»ÄÃµçÁ÷  
 185   1        return QueryCurrentGearILED();  
 186   1        }
 187          
 188          //³õÊ¼»¯Ä£Ê½×´Ì¬»ú
 189          void ModeFSMInit(void)
 190          {
 191   1        char i;
 192   1        //³õÊ¼»¯ÎÞ¼«µ÷¹â
 193   1        SysCfg.RampLimitReachDisplayTIM=0;
 194   1        ReadSysConfig(); //´ÓEEPROMÄÚ¶ÁÈ¡ÎÞ¼«µ÷¹âÅäÖÃ
 195   1        for(i=0;i<ModeTotalDepth;i++)if(ModeSettings[i].ModeIdx==Mode_Ramp) //±éÀúµ²Î»ÉèÖÃ½á¹¹ÌåÑ°ÕÒÎÞ¼«µ÷¹âµÄµ²
             -Î»²¢¶ÁÈ¡ÅäÖÃ
 196   1          {
 197   2          SysCfg.RampBattThres=ModeSettings[i].LowVoltThres; //µÍÑ¹¼ì²âÉÏÏÞ»Ö¸´
 198   2          SysCfg.RampCurrentLimit=ModeSettings[i].Current; //ÕÒµ½µ²Î»Êý¾ÝÖÐÎÞ¼«µ÷¹âµÄµ²Î»£¬µçÁ÷ÉÏÏÞ»Ö¸´
 199   2          //¶ÁÈ¡Êý¾Ý½áÊøºó£¬¼ì²é¶ÁÈëµÄÊý¾ÝÊÇ·ñºÏ·¨£¬²»ºÏ·¨¾ÍÖ±½ÓÐÞÕý
 200   2          if(SysCfg.RampCurrent<ModeSettings[i].MinCurrent)SysCfg.RampCurrent=ModeSettings[i].MinCurrent;
 201   2          if(SysCfg.RampCurrent>SysCfg.RampCurrentLimit)SysCfg.RampCurrent=SysCfg.RampCurrentLimit;
 202   2          //¶ÁÈ¡½áÊø£¬Ìø³öÑ­»·
 203   2          break;
 204   2          }
 205   1        //¸´Î»±äÁ¿
 206   1        RampDIVCNT=3;   
 207   1        //µ²Î»Ä£Ê½ÅäÖÃ
 208   1        ResetSOSModule(); //¸´Î»SOSÄ£¿é
 209   1        LastMode=Mode_Low;
 210   1        ErrCode=Fault_None; //Ã»ÓÐ¹ÊÕÏ
 211   1        CurrentMode=&ModeSettings[0]; //¼ÇÒäÖØÖÃÎªµÚÒ»¸öµµ
 212   1      } 
 213          
 214          //µ²Î»×´Ì¬»úËùÐèµÄÈí¼þ¶¨Ê±Æ÷´¦Àí
 215          void ModeFSMTIMHandler(void)
 216          {
 217   1        //ÎÞ¼«µ÷¹âÏà¹ØµÄ¶¨Ê±Æ÷
 218   1        if(SysCfg.CfgSavedTIM<32)SysCfg.CfgSavedTIM++;
 219   1        if(SysCfg.RampLimitReachDisplayTIM>0)
 220   1          {
 221   2          SysCfg.RampLimitReachDisplayTIM--;
 222   2          if(!SysCfg.RampLimitReachDisplayTIM)IsNotifyMaxRampLimitReached=0; //µ±ÎÞ¼«µ÷¹âÏÔÊ¾¼ÆÊ±Æ÷±äÎª0Ö®ºó£¬¸´Î»
             -±êÖ¾Î»
 223   2          }
 224   1        //Ëø¶¨²Ù×÷ÌáÊ¾¼ÆÊ±Æ÷
 225   1        if(DisplayLockedTIM>0)DisplayLockedTIM--;
 226   1      }
 227          
 228          //µ²Î»Ìø×ª
 229          void SwitchToGear(ModeIdxDef TargetMode)
 230            {
 231   1        char i;
 232   1        int LastICC;
 233   1        bool IsLastModeNeedStepDown;
 234   1        //¼ÇÂ¼»»µµÇ°µÄ½á¹û
 235   1        ModeIdxDef BeforeMode=CurrentMode->ModeIdx;       
C51 COMPILER V9.60.0.0   MODECONTROL                                                       05/18/2025 17:01:21 PAGE 5   

 236   1        IsLastModeNeedStepDown=CurrentMode->IsNeedStepDown; //´æÏÂÊÇ·ñÐèÒª½µµµ
 237   1        if(CurrentMode->ModeIdx==Mode_Turbo)LastICC=QueryTurboCurrent(); //Èç¹ûÊÇ¼«ÁÁµ²Î»ÔòÐèÒªÈ¡µ±Ç°µÄµçÁ÷ÏÞÖÆ×÷
             -Îª×îÖÕµçÁ÷
 238   1        else LastICC=CurrentMode->Current; //´æ´¢»»µ²Ö®Ç°µÄµ²Î»ºÍµçÁ÷Öµ
 239   1        //¿ªÊ¼Ñ°ÕÒ
 240   1        for(i=0;i<ModeTotalDepth;i++)if(ModeSettings[i].ModeIdx==TargetMode)
 241   1          {
 242   2          //¸´Î»ÌØÊâ¹¦ÄÜµ²Î»ÖÁ³õÊ¼×´Ì¬
 243   2          ResetSOSModule();   //¸´Î»Õû¸öSOSÄ£¿é
 244   2          BeaconFSM_Reset(); //¸´Î»Õû¸öÐÅ±êÄ£¿é
 245   2          ResetStrobeModule(); //¸´Î»±¬ÉÁ¿ØÖÆ
 246   2          
 247   2          //ÕÒµ½Æ¥Åäindex£¬½«¶ÔÓ¦µÄ½á¹¹Ìå»ùµØÖ·¸³Öµ¸øÖ¸Õë
 248   2          CurrentMode=&ModeSettings[i]; 
 249   2          //½øÐÐ»»µ²Ö®ºóµÄÎÂ¿Ø½»½ÓºÍÖØÐÂ¼ÆËã¼«ÁÁµçÁ÷ÏÞÖÆ
 250   2          if(BeforeMode!=Mode_Turbo&&TargetMode==Mode_Turbo)CalcTurboILIM(); //´Ó·Ç¼«ÁÁµ²Î»½øÈë¼«ÁÁÖØÐÂ¼ÆËãµçÁ÷Öµ²
             -¢ÖØÖÃMPPTÏµÍ³
 251   2          if(IsLastModeNeedStepDown)RecalcPILoop(LastICC); //ÖØÐÂÉèÖÃPI»·±ÜÃâµçÁ÷¹ýµ÷
 252   2          //ÒÑÕÒµ½Ä¿±êµ²Î»£¬ÍË³öÑ­»·
 253   2          break;
 254   2          }
 255   1        }
 256            
 257          //³¤°´¹Ø»úº¯Êý  
 258          void ReturnToOFFState(void)
 259            {
 260   1        if(CurrentMode->ModeIdx==Mode_OFF)return; //¹Ø»ú×´Ì¬²»Ö´ÐÐ    
 261   1        if(CurrentMode->IsModeHasMemory)LastMode=CurrentMode->ModeIdx; //´æ´¢¹Ø»úÇ°µÄµ²Î»
 262   1        SwitchToGear(Mode_OFF); //Ç¿ÖÆÌø»Øµ½¹Ø»úµ²Î»
 263   1        } 
 264          
 265          //³¤°´»»µ²µÄ¼ä¸ôÃüÁîÉú³É
 266          void HoldSwitchGearCmdHandler(void)
 267            {
 268   1        char buf;
 269   1        if(SysMode||CurrentMode->ModeIdx==Mode_Ramp)HoldChangeGearTIM=0; //Õ½ÊõÄ£Ê½»òÕß½øÈëËø¶¨£¬ÒÔ¼°Î»ÓÚÎÞ¼«µ÷¹â
             -Ä£Ê½ÏÂ£¬½ûÖ¹»»µ²ÏµÍ³ÔËÐÐ
 270   1        else if(!getSideKeyHoldEvent()&&!getSideKey1HEvent())HoldChangeGearTIM=0; //°´¼üËÉ¿ª£¬¼ÆÊ±Æ÷¸´Î»
 271   1        else //Ö´ÐÐ»»µ²³ÌÐò
 272   1          {
 273   2          buf=HoldChangeGearTIM&0x1F; //È¡³öTIMÖµ
 274   2          if(buf==0&&!(HoldChangeGearTIM&0x40))HoldChangeGearTIM|=getSideKey1HEvent()?0x20:0x80; //Áî»»µ²ÃüÁîÎ»1Ö¸
             -Ê¾»»µ²¿ÉÒÔ¼ÌÐø
 275   2          HoldChangeGearTIM&=0xE0; //È¥³ýµôÔ­Ê¼µÄTIMÖµ
 276   2          if(buf<HoldSwitchDelay&&!(HoldChangeGearTIM&0x40))buf++;
 277   2          else buf=0;  //Ê±¼äµ½£¬ÇåÁã½á¹û
 278   2          HoldChangeGearTIM|=buf; //°ÑÊýÖµÐ´»ØÈ¥
 279   2          }
 280   1        } 
 281          
 282          //²à°´³¤°´»»µ²²Ù×÷Ö´ÐÐ
 283          static void SideKeySwitchGearHandler(ModeIdxDef TargetMode) 
 284            {
 285   1        if(!(HoldChangeGearTIM&0x80))return;
 286   1        HoldChangeGearTIM&=0x7F; //Çå³ý±ê¼ÇÎ»±ê¼Ç±¾´Î»»µ²Íê³É
 287   1        SwitchToGear(TargetMode); //»»µ½Ä¿±êµ²Î»
 288   1        }
 289            
 290          //²à°´µ¥»÷+³¤°´»»µ²»ØÍË²Ù×÷Ö´ÐÐ
 291          static void SideKey1HRevGearHandler(ModeIdxDef TargetMode)
 292            {
 293   1        if(!(HoldChangeGearTIM&0x20))return;
C51 COMPILER V9.60.0.0   MODECONTROL                                                       05/18/2025 17:01:21 PAGE 6   

 294   1        HoldChangeGearTIM&=0xDF; //Çå³ý±ê¼ÇÎ»±ê¼Ç±¾´Î»»µ²Íê³É
 295   1        SwitchToGear(TargetMode); //»»µ½Ä¿±êµ²Î»
 296   1        } 
 297            
 298          //ÎÞ¼«µ÷¹â´¦Àí
 299          static void RampAdjHandler(void)
 300            {
 301   1        static bit IsKeyPressed=0;  
 302   1        int Limit;
 303   1        bit IsPress;
 304   1        //¼ÆËã³öÎÞ¼«µ÷¹âÉÏÏÞ
 305   1        IsPress=(getSideKey1HEvent()||getSideKeyHoldEvent())?1:0;
 306   1        Limit=SysCfg.RampCurrentLimit<CurrentMode->Current?SysCfg.RampCurrentLimit:CurrentMode->Current;
 307   1        if(Limit<CurrentMode->Current&&IsPress&&SysCfg.RampCurrent>Limit)SysCfg.RampCurrent=Limit; //ÔÚµçÁ÷±»ÏÞÖÆ
             -µÄÇé¿öÏÂÓÃ»§°´ÏÂ°´¼ü³¢ÊÔµ÷ÕûµçÁ÷£¬Á¢¼´ÏÞ·ù
 308   1        //½øÐÐÁÁ¶Èµ÷Õû
 309   1        if(getSideKeyHoldEvent()&&!IsKeyPressed) //³¤°´Ôö¼ÓµçÁ÷
 310   1            { 
 311   2            if(RampDIVCNT>0)RampDIVCNT--;
 312   2            else 
 313   2              {
 314   3              //Ê±¼äµ½£¬¿ªÊ¼Ôö¼ÓµçÁ÷
 315   3              if(SysCfg.RampCurrent<Limit)SysCfg.RampCurrent++;
 316   3              else
 317   3                {
 318   4                IsNotifyMaxRampLimitReached=1; //±ê¼ÇÒÑ´ïµ½ÉÏÏÞ
 319   4                SysCfg.RampLimitReachDisplayTIM=4; //Ï¨Ãð0.5ÃëÖ¸Ê¾ÒÑ¾­µ½ÉÏÏÞ
 320   4                SysCfg.RampCurrent=Limit; //ÏÞÖÆµçÁ÷×î´óÖµ  
 321   4                IsKeyPressed=1;
 322   4                }
 323   3              //¼ÆÊ±Ê±¼äµ½£¬¸´Î»±äÁ¿
 324   3              RampDIVCNT=3;
 325   3              }
 326   2            } 
 327   1        else if(getSideKey1HEvent()&&!IsKeyPressed) //µ¥»÷+³¤°´¼õÉÙµçÁ÷
 328   1           {
 329   2            if(RampDIVCNT>0)RampDIVCNT--;
 330   2            else
 331   2              {
 332   3              if(SysCfg.RampCurrent>CurrentMode->MinCurrent)SysCfg.RampCurrent--; //¼õÉÙµçÁ÷  
 333   3              else
 334   3                {
 335   4                IsNotifyMaxRampLimitReached=0;
 336   4                SysCfg.RampLimitReachDisplayTIM=4; //Ï¨Ãð0.5ÃëÖ¸Ê¾ÒÑ¾­µ½ÏÂÏÞ
 337   4                SysCfg.RampCurrent=CurrentMode->MinCurrent; //ÏÞÖÆµçÁ÷×îÐ¡Öµ
 338   4                IsKeyPressed=1;
 339   4                }
 340   3              //¼ÆÊ±Ê±¼äµ½£¬¸´Î»±äÁ¿
 341   3              RampDIVCNT=3;
 342   3              }
 343   2           }
 344   1        else if(!IsPress&&IsKeyPressed)
 345   1          {
 346   2          IsKeyPressed=0; //ÓÃ»§·Å¿ª°´¼ü£¬ÔÊÐíµ÷½Ú    
 347   2          RampDIVCNT=3; //¸´Î»·ÖÆµ¼ÆÊ±Æ÷
 348   2          }
 349   1        //½øÐÐÊý¾Ý±£´æµÄÅÐ¶Ï
 350   1        if(IsPress)SysCfg.CfgSavedTIM=0; //°´¼ü°´ÏÂËµÃ÷ÕýÔÚµ÷Õû£¬¸´Î»¼ÆÊ±Æ÷
 351   1        else if(SysCfg.CfgSavedTIM==32)
 352   1            {
 353   2            SysCfg.CfgSavedTIM++;
 354   2            SaveSysConfig(0);  //Ò»¶ÎÊ±¼äÄÚÃ»²Ù×÷ËµÃ÷ÒÑ¾­µ÷½ÚÍê±Ï£¬±£´æÊý¾Ý
C51 COMPILER V9.60.0.0   MODECONTROL                                                       05/18/2025 17:01:21 PAGE 7   

 355   2            }
 356   1        }
 357          
 358          //¼ì²âÊÇ·ñÐèÒª¹Ø»ú
 359          static void DetectIfNeedsOFF(int ClickCount)
 360            {
 361   1        if(getSideKeyNClickAndHoldEvent()==2)TriggerVshowDisplay();
 362   1        if(!SysMode&&ClickCount!=1)return;
 363   1        if(SysMode&&getSideKeyHoldEvent())return;
 364   1        ReturnToOFFState();//²à°´µ¥»÷»òÕßÔÚÕ½ÊõÄ£Ê½ÏÂËÉ¿ª°´Å¥Ê±¹Ø»ú
 365   1        } 
 366          
 367          //µ²Î»×´Ì¬»ú
 368          void ModeSwitchFSM(void)
 369            {
 370   1        char ClickCount;
 371   1        //»ñÈ¡°´¼ü×´Ì¬
 372   1        if(GetIfSystemInPOFFSeq())return; //ÏµÍ³´¦ÓÚ¹Ø»ú¹ý³ÌÖÐ£¬²»Ö´ÐÐ°´¼ü´¦Àí
 373   1        ClickCount=getSideKeyShortPressCount(0);  //¶ÁÈ¡°´¼ü´¦Àíº¯Êý´«¹ýÀ´µÄ²ÎÊý
 374   1        //µ²Î»¼ÇÒä²ÎÊý¼ì²éºÍEEPROM¼ÇÒä
 375   1        if(LastMode==Mode_OFF||LastMode>=ModeTotalDepth)LastMode=Mode_Low;
 376   1        //×´Ì¬»ú
 377   1        IsHalfBrightness=0; //°´¼üµÆÄ¬ÈÏÈ«ÁÁ
 378   1        switch(CurrentMode->ModeIdx)  
 379   1          {
 380   2          //³öÏÖ´íÎó  
 381   2          case Mode_Fault:
 382   2            SysMode=Operation_Normal; //¹ÊÕÏºó×Ô¶¯»Øµ½ÆÕÍ¨Ä£Ê½      
 383   2            if(!getSideKeyLongPressEvent()||IsErrorFatal())break; //ÓÃ»§Ã»ÓÐ°´ÏÂ°´Å¥»òÕßÊÇÖÂÃüµÄ´íÎó×´Ì¬²»ÔÊÐíÖØÖÃ
 384   2            ClearError(); //Ïû³ýµôµ±Ç°´íÎó
 385   2            break;
 386   2          //¹Ø»ú×´Ì¬
 387   2          case Mode_OFF:      
 388   2            //´¦ÀíÌØÊâ¹¦ÄÜ
 389   2            if(LocLEDState==LocateLED_NotEdit)
 390   2              {
 391   3              SpecialModeOperation(ClickCount);  //Ö»ÓÐÔÚÍË³öÁË¶¨Î»LED±à¼­Ä£Ê½Ö®ºó²ÅÄÜÖ´ÐÐ
 392   3              if(SysMode)break;
 393   3              }
 394   2            //´¦Àí¶¨Î»LED±ä¸ü
 395   2            if(LocateLED_Edit(ClickCount))break;
 396   2            //·ÇÌØÊâÄ£Ê½Õý³£µ¥»÷¿ª¹Ø»úµÄÊÂÏî
 397   2            if(ClickCount==1)PowerToNormalMode(LastMode); //²à°´µ¥»÷¿ª»ú½øÈëÑ­»·  
 398   2            //½øÈë¼«ÁÁºÍ±¬ÉÁ
 399   2            else EnterTurboStrobe(ClickCount);    
 400   2            if(getSideKeyLongPressEvent())SwitchToGear(Mode_Moon); //³¤°´¿ª»úÖ±½Ó½øÔÂ¹â         
 401   2            if(ClickCount==4) //ËÄ»÷ÇÐ»»µ²Î»Ä£Ê½ºÍÎÞ¼«µ÷¹â
 402   2                { 
 403   3                IsRampEnabled=~IsRampEnabled; //×ª»»ÎÞ¼«µ÷¹â×´Ì¬  
 404   3                LEDMode=IsRampEnabled?LED_GreenBlinkThird:LED_RedBlinkThird; //ÏÔÊ¾ÊÇ·ñ¿ªÆô
 405   3                SaveSysConfig(0); //±£´æÅäÖÃµ½ROMÄÚ
 406   3                }
 407   2            //²éÑ¯µçÑ¹
 408   2            if(getSideKeyNClickAndHoldEvent())TriggerVshowDisplay();
 409   2            break;
 410   2          //ÔÂ¹â×´Ì¬
 411   2           case Mode_Moon:
 412   2             IsHalfBrightness=1; //ÔÂ¹âÄ£Ê½°´¼üµÆÁÁ¶È¼õ°ë
 413   2             BatteryLowAlertProcess(true,Mode_Moon);
 414   2             DetectIfNeedsOFF(ClickCount); //Ö´ÐÐ¹Ø»ú¶¯×÷¼ì²â 
 415   2             //µç³ØµçÑ¹³ä×ã£¬³¤°´½øÈëµÍÁÁµ²Î»
 416   2             if(getSideKeyLongPressEvent())  
C51 COMPILER V9.60.0.0   MODECONTROL                                                       05/18/2025 17:01:21 PAGE 8   

 417   2                {
 418   3                PowerToNormalMode(Mode_ExtremelyLow); //¿ª»úµ½¼«µÍÁÁÄ£Ê½
 419   3                if(CurrentMode->ModeIdx==Mode_Moon)break;//»»µ²Ö®ºóÎÞ·¨³É¹¦Àë¿ªÔÂ¹âÄ£Ê½£¬²»½øÐÐÏÂÃæµÄ¸´Î»²Ù×÷
 420   3                if(IsRampEnabled)RestoreToMinimumSysCurrent(); //Èç¹ûÊÇÎÞ¼«µ÷¹âÔò»Ö¸´µ½×îµÍµçÁ÷
 421   3                HoldChangeGearTIM|=0x40; //½ûÖ¹»»µ²ÏµÍ³¹¤×÷
 422   3                }       
 423   2              break;      
 424   2          //ÎÞ¼«µ÷¹â×´Ì¬        
 425   2          case Mode_Ramp:
 426   2              DetectIfNeedsOFF(ClickCount); //¼ì²âÊÇ·ñÐèÒª¹Ø»ú
 427   2              EnterTurboStrobe(ClickCount); //½øÈë¼«ÁÁ»òÕß±¬ÉÁµÄ¼ì²â
 428   2              //ÎÞ¼«µ÷¹â´¦Àí
 429   2              RampLowVoltHandler(); //µÍµçÑ¹±£»¤
 430   2              RampAdjHandler();     
 431   2              break;
 432   2          //¼«µÍÁÁ
 433   2          case Mode_ExtremelyLow:         
 434   2              BatteryLowAlertProcess(true,Mode_ExtremelyLow);
 435   2              DetectIfNeedsOFF(ClickCount); //Ö´ÐÐ¹Ø»ú¶¯×÷¼ì²â
 436   2              EnterTurboStrobe(ClickCount); //½øÈë¼«ÁÁ»òÕß±¬ÉÁµÄ¼ì²â
 437   2              SideKeySwitchGearHandler(Mode_Low); //»»µ½µÍµµ
 438   2              break;          
 439   2          //µÍÁÁ×´Ì¬    
 440   2          case Mode_Low:
 441   2              BatteryLowAlertProcess(false,Mode_ExtremelyLow);
 442   2              DetectIfNeedsOFF(ClickCount); //Ö´ÐÐ¹Ø»ú¶¯×÷¼ì²â
 443   2              EnterTurboStrobe(ClickCount); //½øÈë¼«ÁÁ»òÕß±¬ÉÁµÄ¼ì²â
 444   2              //³¤°´»»µ²´¦Àí
 445   2              SideKey1HRevGearHandler(Mode_ExtremelyLow); //µ¥»÷+³¤°´»ØÍËµ²Î»µ½¼«µÍµµ
 446   2              SideKeySwitchGearHandler(Mode_Mid); //»»µ½ÖÐµµ
 447   2              break;          
 448   2          //ÖÐÁÁ×´Ì¬    
 449   2          case Mode_Mid:
 450   2              BatteryLowAlertProcess(false,Mode_Low);
 451   2              DetectIfNeedsOFF(ClickCount); //Ö´ÐÐ¹Ø»ú¶¯×÷¼ì²â
 452   2              EnterTurboStrobe(ClickCount); //½øÈë¼«ÁÁ»òÕß±¬ÉÁµÄ¼ì²â
 453   2              //³¤°´»»µ²´¦Àí
 454   2              SideKeySwitchGearHandler(Mode_MHigh); //»»µ½ÖÐ¸ßµµ
 455   2              SideKey1HRevGearHandler(Mode_Low); //µ¥»÷+³¤°´»ØÍËµ²Î»µ½µÍµµ
 456   2              break;  
 457   2          //ÖÐ¸ßÁÁ×´Ì¬
 458   2          case Mode_MHigh:
 459   2              BatteryLowAlertProcess(false,Mode_Mid);
 460   2              DetectIfNeedsOFF(ClickCount); //Ö´ÐÐ¹Ø»ú¶¯×÷¼ì²â
 461   2              EnterTurboStrobe(ClickCount); //½øÈë¼«ÁÁ»òÕß±¬ÉÁµÄ¼ì²â
 462   2              //³¤°´»»µ²´¦Àí
 463   2              SideKeySwitchGearHandler(Mode_High); //»»µ½¸ßµµ
 464   2              SideKey1HRevGearHandler(Mode_Mid); //µ¥»÷+³¤°´»ØÍËµ²Î»µ½ÖÐµµ
 465   2              break;  
 466   2          //¸ßÁÁ×´Ì¬
 467   2          case Mode_High:
 468   2              BatteryLowAlertProcess(false,Mode_MHigh);
 469   2              DetectIfNeedsOFF(ClickCount); //Ö´ÐÐ¹Ø»ú¶¯×÷¼ì²â
 470   2              EnterTurboStrobe(ClickCount); //½øÈë¼«ÁÁ»òÕß±¬ÉÁµÄ¼ì²â
 471   2              //³¤°´»»µ²´¦Àí
 472   2              SideKeySwitchGearHandler(Mode_ExtremelyLow); //»»µ½¼«µÍµµÎ»¹¹³ÉÑ­»·  
 473   2              SideKey1HRevGearHandler(Mode_MHigh); //µ¥»÷+³¤°´»ØÍËµ²Î»µ½ÖÐ¸ßµµ
 474   2              break;
 475   2          //¼«ÁÁ×´Ì¬
 476   2          case Mode_Turbo:
 477   2              TurboLVILIMProcess(); //Ö´ÐÐ¼«ÁÁµÍµçÁ÷¼ì²â
 478   2              DetectIfNeedsOFF(ClickCount); //Ö´ÐÐ¹Ø»ú¶¯×÷¼ì²â
C51 COMPILER V9.60.0.0   MODECONTROL                                                       05/18/2025 17:01:21 PAGE 9   

 479   2              SideKeySwitchGearHandler(Mode_High); //³¤°´ÍË»Ø¸ßµµ 
 480   2              if(ClickCount==2||IsForceLeaveTurbo)SwitchToGear(IsRampEnabled?Mode_Ramp:Mode_Low); //Ë«»÷»òÕßÎÂ¶È´ïµ
             -½ÉÏÏÞÖµ£¬Ç¿ÖÆ·µ»Øµ½µÍÁÁ
 481   2              if(ClickCount==3)SwitchToGear(Mode_Strobe); //²à°´3»÷½øÈë±¬ÉÁ
 482   2              break;  
 483   2          //±¬ÉÁ×´Ì¬
 484   2          case Mode_Strobe:
 485   2              BatteryLowAlertProcess(true,Mode_Strobe);
 486   2              DetectIfNeedsOFF(ClickCount); //Ö´ÐÐ¹Ø»ú¶¯×÷¼ì²â
 487   2              LeaveSpecialMode(ClickCount); //ÍË³öÌØÊâÄ£Ê½»Øµ½ÆäËûµØ·½µÄÈë¿Ú
 488   2              //³¤°´»»µ²´¦Àí
 489   2              SideKeySwitchGearHandler(Mode_SOS); //³¤°´ÇÐ»»µ½SOS
 490   2              break;  
 491   2          //SOSÇó¾Èµ²Î»   
 492   2          case Mode_SOS:
 493   2              BatteryLowAlertProcess(true,Mode_SOS);
 494   2              DetectIfNeedsOFF(ClickCount); //Ö´ÐÐ¹Ø»ú¶¯×÷¼ì²â
 495   2              LeaveSpecialMode(ClickCount); //ÍË³öÌØÊâÄ£Ê½»Øµ½ÆäËûµØ·½µÄÈë¿Ú
 496   2              //³¤°´»»µ²´¦Àí
 497   2              SideKeySwitchGearHandler(Mode_Beacon); //³¤°´ÇÐ»»µ½ÐÅ±ê
 498   2              break;  
 499   2          //ÐÅ±êµ²Î»
 500   2          case Mode_Beacon:
 501   2              BatteryLowAlertProcess(true,Mode_Beacon);
 502   2              DetectIfNeedsOFF(ClickCount); //Ö´ÐÐ¹Ø»ú¶¯×÷¼ì²â
 503   2              LeaveSpecialMode(ClickCount); //ÍË³öÌØÊâÄ£Ê½»Øµ½ÆäËûµØ·½µÄÈë¿Ú
 504   2              //³¤°´»»µ²´¦Àí
 505   2              SideKeySwitchGearHandler(Mode_Strobe); //³¤°´ÇÐ»»µ½±¬ÉÁ
 506   2              break;        
 507   2          }
 508   1        //Ó¦ÓÃÊä³öµçÁ÷
 509   1        if(DisplayLockedTIM||IsDisplayLocked)Current=CalcIREFValue(50); //ÓÃ»§½øÈë»òÕßÍË³öËø¶¨£¬ÓÃ50mA¶ÌÔÝµãÁÁÌáÊ
             -¾Ò»ÏÂ
 510   1        else switch(CurrentMode->ModeIdx) 
 511   1          {
 512   2          case Mode_Turbo:Current=QueryTurboCurrent();break; //¼«ÁÁÄ£Ê½
 513   2          case Mode_Beacon: //ÐÅ±êÄ£Ê½      
 514   2          case Mode_SOS: 
 515   2          case Mode_Strobe://±¬ÉÁÄ£Ê½ºÍSOSÄ£Ê½       
 516   2             switch(BattState)//È¡³öµ²Î»µçÁ÷
 517   2               {
 518   3               case Battery_Plenty:Current=QueryCurrentGearILED();break;
 519   3               case Battery_Mid:Current=CalcIREFValue(10000);break;
 520   3               case Battery_Low:Current=CalcIREFValue(8000);break;
 521   3               case Battery_VeryLow:Current=CalcIREFValue(2000);break;
 522   3               }
 523   2             //¸ù¾Ý×´Ì¬¿ØÖÆµçÁ÷
 524   2             if(CurrentMode->ModeIdx==Mode_Strobe&&!StrobeOutputHandler())Current=-1; 
 525   2             if(CurrentMode->ModeIdx==Mode_SOS&&!SOSFSM())Current=-1;
 526   2             if(CurrentMode->ModeIdx==Mode_Beacon)switch(BeaconFSM())
 527   2               {
 528   3               case 0:Current=-1;break; //0±íÊ¾ÈÃµçÁ÷¹Ø±Õ
 529   3               case 2:Current=CalcIREFValue(200);break; //ÓÃ200mAµÍÁÁÌáÊ¾¸æÖªÓÃ»§ÒÑ½øÈëÐÅ±êÄ£Ê½
 530   3               case 1:break; //µçÁ÷1²»½øÐÐÈÎºÎ´¦Àí
 531   3               }
 532   2             break; 
 533   2          //ÆäÓàÄ£Ê½£¬µçÁ÷È¡Õý³£Öµ
 534   2          default:
 535   2            if(LowPowerStrobe())Current=-1; //´¥·¢µÍÑ¹±¨¾¯£¬ÉÁË¸
 536   2            else if(CurrentMode->ModeIdx==Mode_Ramp)Current=SysCfg.RampCurrentLimit<SysCfg.RampCurrent?SysCfg.RampC
             -urrentLimit:SysCfg.RampCurrent; //ÎÞ¼«µ÷¹âÄ£Ê½È¡½á¹¹ÌåÄÚÊý¾Ý
 537   2            else Current=QueryCurrentGearILED();//ÆäËûµ²Î»Ê¹ÓÃÉèÖÃÖµ×÷ÎªÄ¿±êµçÁ÷
C51 COMPILER V9.60.0.0   MODECONTROL                                                       05/18/2025 17:01:21 PAGE 10  

 538   2          }
 539   1        //ÎÞ¼«µ÷¹âÄ£Ê½Ö¸Ê¾(ÎÞ¼«µ÷¹âÄ£Ê½ÔÚµÖ´ïÉÏÏÂÏÞºó¶ÌÔÝÏ¨Ãð»òÕßµ÷µ½33%)
 540   1        if(SysCfg.RampLimitReachDisplayTIM)Current=IsNotifyMaxRampLimitReached?Current/3:-1;
 541   1        //Çå³ý°´¼ü´¦Àí
 542   1        getSideKeyShortPressCount(1); 
 543   1        }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1738    ----
   CONSTANT SIZE    =    117    ----
   XDATA SIZE       =      4    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     12      12
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      3       1
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)

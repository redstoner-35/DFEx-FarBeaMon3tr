C51 COMPILER V9.60.0.0   SPECIALMODE                                                       05/18/2025 17:01:21 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE SPECIALMODE
OBJECT MODULE PLACED IN .\Objects\SpecialMode.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Logic\SpecialMode.c OMF2 OPTIMIZE(9,SPEED) BROWSE MODDP2 INCDIR(.\StdDri
                    -ver\inc;.\Hardware;.\include\Hardware;.\include\Logic;.\include\Middleware;.\include\System) DEFINE(EnableStdGPIO) DEBUG
                    - PRINT(.\Listings\SpecialMode.lst) TABS(2) OBJECT(.\Objects\SpecialMode.obj)

line level    source

   1          #include "ModeControl.h"
   2          #include "LEDMgmt.h"
   3          #include "SideKey.h"
   4          #include "BattDisplay.h"
   5          #include "TempControl.h"
   6          #include "SpecialMode.h"
   7          #include "SysConfig.h"
   8          #include "LowVoltProt.h"
   9          
  10          //全局变量和外部声明
  11          extern xdata char DisplayLockedTIM;
  12          static xdata char ShowTacModeTIM;
  13          bit IsDisplayLocked;
  14          SpecialOperationDef SysMode; //系统模式
  15          
  16          //进入退出锁定切换
  17          static void EnterExitLock(void)
  18            {
  19   1        DisplayLockedTIM=8; //指示锁定状态切换
  20   1        SysMode=!SysMode?Operation_Locked:Operation_Normal;
  21   1        SaveSysConfig(0);
  22   1        }
  23            
  24          //进入退出战术切换
  25          static void EnterExitTac(void)
  26            {
  27   1        DisplayLockedTIM=2; //指示战术切换
  28   1        SysMode=!SysMode?Operation_TacTurbo:Operation_Normal;
  29   1        } 
  30          
  31          //开启到普通模式
  32          void PowerToNormalMode(ModeIdxDef Mode)
  33            {
  34   1        if(Battery>2.9)SwitchToGear(IsRampEnabled?Mode_Ramp:Mode); //正常开启
  35   1        else if(Battery>2.55)SwitchToGear(Mode_Moon);  //大于2.5V的时候只能开月光
  36   1        else LEDMode=LED_RedBlinkFifth; //电池电量严重不足，红色闪五次
  37   1        //如果成功进入了无级模式，则进行复位处理
  38   1        if(CurrentMode->ModeIdx==Mode_Ramp)RampRestoreLVProtToMax();
  39   1        }
  40            
  41          //进入极亮和爆闪的判断
  42          void EnterTurboStrobe(char ClickCount)  
  43            {
  44   1        //双击极亮
  45   1        if(ClickCount==2)
  46   1          {
  47   2          if(Battery>3.1)SwitchToGear(Mode_Turbo); //电池电量充足正常开启
  48   2          else PowerToNormalMode(LastMode);  //电池电池电量不足时双击进入普通模式
  49   2          }
  50   1        //三击爆闪
  51   1        if(ClickCount==3)
  52   1          {
  53   2          if(Battery>2.7)SwitchToGear(Mode_Strobe);   //进入爆闪
C51 COMPILER V9.60.0.0   SPECIALMODE                                                       05/18/2025 17:01:21 PAGE 2   

  54   2          else LEDMode=LED_RedBlinkFifth; //电量不足五次闪烁提示
  55   2          }
  56   1        }
  57            
  58          //特殊模式下回到特殊功能里面的切换
  59          void LeaveSpecialMode(char ClickCount)  
  60            {
  61   1        if(ClickCount==2&&!IsDisableTurbo)SwitchToGear(Mode_Turbo); //双击极亮
  62   1        if(ClickCount==3)SwitchToGear(IsRampEnabled?Mode_Ramp:Mode_Low); //三击退回到普通模式
  63   1        } 
  64          
  65          //显示战术模式启用
  66          bit DisplayTacModeEnabled(void)
  67            {
  68   1        //计时器控制
  69   1        if(CurrentMode->ModeIdx!=Mode_OFF||SysMode<Operation_TacTurbo)ShowTacModeTIM=0;
  70   1        else //进行累加
  71   1          {
  72   2          ShowTacModeTIM++; //进行增加
  73   2          if(ShowTacModeTIM==14&&SysMode==Operation_TacStrobe)return 1; //战术爆闪模式激活，频闪2次
  74   2          else if(ShowTacModeTIM==16)
  75   2            {
  76   3            ShowTacModeTIM=0;
  77   3            return 1; //返回1打开显示
  78   3            }   
  79   2          }
  80   1        //其余状态返回0
  81   1        return 0;
  82   1        } 
  83            
  84          //特殊功能切换  
  85          void SpecialModeOperation(char Click)
  86            {
  87   1          //复位flag
  88   1          IsDisplayLocked=0;
  89   1          //特殊操作模式切换
  90   1            switch(SysMode)
  91   1              {
  92   2              //普通模式
  93   2              case Operation_Normal:
  94   2                if(Click==5)EnterExitLock(); //进入锁定模式
  95   2                if(Click==6)EnterExitTac(); //进入战术模式
  96   2                break;
  97   2              //锁定模式
  98   2              case Operation_Locked:
  99   2                 if(Click==5)EnterExitLock();
 100   2                 else if(getSideKeyHoldEvent())IsDisplayLocked=1;
 101   2                 else if(IsKeyEventOccurred())LEDMode=LED_RedBlinkFifth; //指示手电已被锁定
 102   2                 break;
 103   2              //战术模式
 104   2              case Operation_TacTurbo:
 105   2              case Operation_TacStrobe:
 106   2                if(Click==6)EnterExitTac();
 107   2                if(Click==2) //切换模式
 108   2                  {
 109   3                  if(SysMode==Operation_TacTurbo)
 110   3                    {
 111   4                    SysMode=Operation_TacStrobe;
 112   4                    LEDMode=LED_GreenBlinkThird; //开启爆闪战术
 113   4                    }
 114   3                  else
 115   3                    {
C51 COMPILER V9.60.0.0   SPECIALMODE                                                       05/18/2025 17:01:21 PAGE 3   

 116   4                    SysMode=Operation_TacTurbo;
 117   4                    LEDMode=LED_RedBlinkThird;  //关闭爆闪战术
 118   4                    }
 119   3                  }
 120   2                if(getSideKeyHoldEvent())EnterTurboStrobe(SysMode==Operation_TacStrobe?3:2); //调用进入函数尝试进极亮
 121   2              break;
 122   2              }
 123   1        } 


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    434    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      1    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      1       4
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
